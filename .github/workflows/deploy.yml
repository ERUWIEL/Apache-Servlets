name: Build and Deploy Java App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: |
        mvn clean package -DskipTests
        echo "âœ… Build completed"
        ls -lh target/*.war
    
    - name: Install cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        cloudflared --version
    
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan ssh.erwbyel.org >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: Setup Cloudflare Access Credentials
      run: |
        # Crear archivo de credenciales para cloudflared
        mkdir -p ~/.cloudflared
        cat > ~/.cloudflared/access-creds.json << EOF
        {
          "id": "${{ secrets.CF_ACCESS_CLIENT_ID }}",
          "secret": "${{ secrets.CF_ACCESS_CLIENT_SECRET }}"
        }
        EOF
        chmod 600 ~/.cloudflared/access-creds.json
        
        # Configurar SSH para usar cloudflared con las credenciales
        cat > ~/.ssh/config << 'EOF'
        Host homelab
          HostName ssh.erwbyel.org
          User erwbyel
          ProxyCommand bash -c 'cloudflared access ssh --hostname %h --id $(jq -r .id ~/.cloudflared/access-creds.json) --secret $(jq -r .secret ~/.cloudflared/access-creds.json)'
          StrictHostKeyChecking no
          UserKnownHostsFile=/dev/null
          ServerAliveInterval 60
        EOF
        chmod 600 ~/.ssh/config
        
        # Instalar jq para parsear JSON
        sudo apt-get update -qq && sudo apt-get install -y jq
    
    - name: Test SSH Connection
      run: |
        echo "ðŸ”Œ Testing SSH connection..."
        ssh homelab "echo 'âœ… Connected!' && whoami && hostname && uptime"
    
    - name: Deploy WAR to Server
      run: |
        WAR_FILE=$(ls target/*.war | head -n 1)
        WAR_NAME=$(basename "$WAR_FILE")
        
        echo "ðŸ“¦ Deploying $WAR_NAME..."
        
        # Copiar WAR
        scp "$WAR_FILE" homelab:/srv/docker/volumes/apps/tomcat-dev/webapps/
        
        # Reiniciar Tomcat
        ssh homelab << 'ENDSSH'
          set -e
          cd /srv/docker/stacks/apps/tomcat-dev
          
          echo "ðŸ”„ Restarting Tomcat container..."
          docker compose restart
          
          echo "â³ Waiting for Tomcat..."
          sleep 15
          
          echo "ðŸ“Š Container status:"
          docker compose ps
          
          echo "ðŸ“ Recent logs:"
          docker compose logs --tail=30 tomcat
          
          echo "âœ… Deployment completed!"
        ENDSSH
    
    - name: Verify Deployment
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸŒ Your app is available at: https://demo.erwbyel.org/"
        echo ""
        echo "ðŸ“Š To check logs:"
        echo "   ssh homelab 'docker logs -f tomcat-dev'"
