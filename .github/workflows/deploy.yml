name: deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Install Maven  # â† NUEVO PASO
      run: |
        # Verificar si Maven ya estÃ¡ instalado
        if ! command -v mvn &> /dev/null; then
          echo "ğŸ“¦ Installing Maven..."
          sudo apt-get update -qq
          sudo apt-get install -y maven
          mvn --version
        else
          echo "âœ… Maven already installed"
          mvn --version
        fi
    
    - name: Build with Maven
      run: |
        mvn clean package -DskipTests
        echo "âœ… Build completed"
        ls -lh target/*.war
    
    - name: Deploy to Tomcat
      run: |
        WAR_FILE=$(ls target/*.war | head -n 1)
        WAR_NAME=$(basename "$WAR_FILE")
        
        echo "ğŸ“¦ Deploying $WAR_NAME..."
        
        # Limpiar deployment anterior
        rm -f /srv/docker/volumes/apps/tomcat-dev/webapps/*.war
        rm -rf /srv/docker/volumes/apps/tomcat-dev/webapps/*/
        
        # Copiar nuevo WAR
        cp "$WAR_FILE" /srv/docker/volumes/apps/tomcat-dev/webapps/ROOT.war
        
        # Reiniciar Tomcat
        cd /srv/docker/stacks/apps/tomcat-dev
        docker compose restart
        
        echo "â³ Waiting for Tomcat to start..."
        sleep 20
        
        echo "ğŸ“Š Container status:"
        docker compose ps
        
        echo "âœ… Deployment completed!"
    
    - name: Show deployment info
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ‰ Deployment Successful!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸŒ Your app is live at:"
        echo "   https://demo.erwbyel.org/"
        echo ""
